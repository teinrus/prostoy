{% extends 'base.html' %}

{% block content %}
    <head>
        <title>Отчет простоев линии 5</title>
    </head>

    <body style="padding: 0px 50px; margin-top: 20px; margin-left: 20px;">

    <style>
        .col__list {
            margin: 0;
            padding: 0;
            width: calc((100% - 20px) / 2);
            display: flex;
            list-style: none;
            flex-wrap: wrap;
            justify-content: space-between;
        }

        .col__item {
            margin: 0;
            padding: 0;
            display: flex;
            width: calc((100% - 10px) / 2);
            outline: 2px solid #000;
            justify-content: center;
            align-items: center;
            font-size: 15px;
        }

        .col__item:nth-child(-n+2) {
            margin-bottom: 10px;
        }

        .col__item:nth-last-child(-n+2) {
            margin-bottom: 0px;
        }
    </style>

    <script>//ajax для перезагрузки графика и ли#}
    $(document).ready(function () {
        var Char = null;
         $.ajax({
                url: 'getData',
                method: 'post',
                success: function (data) {

                    $('#avgSpeeds').html(data.avgSpeed);
                    $('#allProc').html(data.allProc);
                    $('#boomOut').html(data.boomOut);
                    $('#sumProstoy').html(data.sumProstoy);


                }
            });
        setInterval(function () {

            $.ajax({
                url: 'getData',
                method: 'post',
                success: function (data) {

                    $('#avgSpeeds').html(data.avgSpeed);
                    $('#allProc').html(data.allProc);
                    $('#boomOut').html(data.boomOut);
                    $('#sumProstoy').html(data.sumProstoy);


                }
            });

        }, 3000);
        $.ajax({
                url: 'getData',
                method: 'post',
                success: function (data) {

                    if (Char != null) {
                        Char.destroy();
                    }
                    ;

                    Char = new Chart("myChart", {
                        type: 'bar',
                        data: {
                            labels: data.lableChart,
                            datasets: [{
                                label: '# Производительность линии 5',
                                data: data.dataChart,
                                borderWidth: 1
                            }]
                        },
                        options: {
                            animation: false,
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });

                }
            });
        setInterval(function () {
            $.ajax({
                url: 'getData',
                method: 'post',
                success: function (data) {

                    if (Char != null) {
                        Char.destroy();
                    }
                    ;

                    Char = new Chart("myChart", {
                        type: 'bar',
                        data: {
                            labels: data.lableChart,
                            datasets: [{
                                label: '# Производительность линии 5',
                                data: data.dataChart,
                                borderWidth: 1
                            }]
                        },
                        options: {
                            animation: false,
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });

                }
            });

        }, 2000);


    });
    </script>

    <script>

        $(document).ready(function () {
            var item_num = $(this).attr('id');
            update_item(item_num)
            setInterval(function () {
                var item_num = $(this).attr('id');
                update_item(item_num);
            }, 60000);

            function update_item(item_num) {
                $('#sample_data tbody').html('').load(
                    "{% url 'update_items' %}?item_num=" + item_num
                ).sort();
            }
        });


    </script>

    <script> // зависимости выпадающих списков таблици
    $(document).ready(function () {
        var sor = [];
        let allProstoy
        var test =
        {{ prich|safe }}
        var temp = '%'
        $(function () {


            $('#sample_data').mousemove(function () {
                $('td.otv_pod', this).mousedown(function () {

                    temp = '';
                    for (let i = 0; i < test.length; i++) {
                        if ($(this).text() === test[i].key) {
                            temp += test[i].prichina + '%'
                        }
                    }
                    allProstoy = temp.split('%')
                    sor = [];
                    for (let n = 0; n < allProstoy.length; n++) {
                        if (allProstoy[n] !== '') {
                            sor.push({value: allProstoy[n], text: allProstoy[n]})
                        }
                    }
                })
            });
            $('#sample_data').editable({
                container: 'body',
                selector: 'td.prichina',
                url: '/update',
                title: 'prichina',
                type: 'POST',
                value: "Не выбрано",
                source:
                    function () {
                        return sor
                    },
                validate: function (value) {
                    if ($.trim(value)) {
                    }
                }
            });
        });

        var dataTable = $('#sample_data').DataTable();

        $('#sample_data').editable({
            container: 'body',
            selector: 'td.uchastok',
            url: '/update',
            title: 'uchastok',
            type: 'POST',
            value: "Не выбрано",
            source:
                [
                    {% for el in uch %}
                        {value: "{{ el }}", text: "{{ el }}"},
                    {% endfor %}],
            validate: function (value) {
                if ($.trim(value) == '') {
                    return 'This field is required';
                }
            }
        });

        $('#sample_data').editable({
            container: 'body',
            selector: 'td.otv_pod',
            url: '/update',
            title: 'otv_pod',
            type: 'POST',
            source: [
                {% for el in otv_p %}
                    {value: "{{ el }}", text: "{{ el }}"},
                {% endfor %}
            ],
            validate: function (value) {
                if ($.trim(value)) {
                    console.log(value)
                    for (let i = 0; i < test.length; i++) {
                        if (value === test[i].key) {
                            temp += test[i].prichina + '%'
                        }
                    }
                    allProstoy = temp.split('%')
                    sor = [];
                    for (let n = 0; n < allProstoy.length; n++) {
                        if (allProstoy[n] !== '') {
                            sor.push({value: allProstoy[n], text: allProstoy[n]})
                        }
                    }
                }
            }
        });

        $('#sample_data').editable({
            container: 'body',
            selector: 'td.comment',
            url: '/update',
            title: 'comment',
            type: 'POST',
            value: "Не выбрано",

            validate: function (value) {
                if ($.trim(value) == '') {
                    return 'This field is required';
                }
            }
        });
    });
    </script>


    <div class="col__wrapper"
         style=" display: flex; flex-direction: row; justify-content: space-between; margin-bottom: 20px;  margin-top: 1rem;">
        <div class="col" style="width: calc((100% - 30px) / 2); outline: 2px solid #000; ">
            <canvas id="myChart"></canvas>
        </div>
        <ul class="col__list">
            <li class="col__item">
                <ul>
                    <li style="list-style-type: none; font-size:23px">Средняя производительность линии</li>
                    <li id="avgSpeeds"
                        style="text-align: center; font-size:70px; list-style-type: none;">{{ avgSpeed }}</li>
                </ul>
            </li>
            <li class="col__item">
                <ul>
                    <li style="list-style-type: none; font-size:23px">Взрывы бутылки</li>
                    <li id="boomOut" style="text-align: center; font-size:70px; list-style-type: none;"></li>
                </ul>
            <li class="col__item">
                <ul>
                    <li style="list-style-type: none; font-size:23px">Общее время простоя</li>
                    <li id="sumProstoy" style="text-align: center; font-size:70px; list-style-type: none;"></li>
                </ul>
            <li class="col__item">
                <ul>
                    <li style="list-style-type: none; font-size:23px">Процент выполнения</li>
                    <li id="allProc" style="text-align: center; font-size:70px; list-style-type: none;"></li>
                </ul>
        </ul>
    </div>
    <table id="sample_data" class="table table-bordered table-striped"
           style="width: calc((100% - 30px)); outline: 2px solid #000; margin-top: 20px;">
        <thead>
        <tr>
            <th>id</th>
            <th>Дата</th>
            <th>Время начала простоя</th>
            <th>Время простоя</th>
            <th>Участок</th>

            <th>Ответст. подразделение</th>
            <th>Причина</th>
            <th>Комментарий</th>
        </thead>
        <tbody>
        {% include 'table_body.html' %}
        </tbody>
    </table>
    </body>
{% endblock %}